#!/bin/bash
# BlueSecAudit v2.0 - Advanced Bluetooth Security Auditing Tool
# Vers√£o completamente refatorada com TDD e arquitetura modular
# Autor: BlueSecAudit Team
# Licen√ßa: MIT

set -euo pipefail

# Diret√≥rio base do script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Importar m√≥dulos
source "${SCRIPT_DIR}/lib/utils.sh"
source "${SCRIPT_DIR}/lib/bluetooth.sh"
source "${SCRIPT_DIR}/lib/attacks.sh"
source "${SCRIPT_DIR}/lib/ui.sh"
source "${SCRIPT_DIR}/lib/hid_attacks.sh"
source "${SCRIPT_DIR}/lib/audio_attacks.sh"
source "${SCRIPT_DIR}/lib/ble_attacks.sh"

# Configura√ß√µes globais
CONFIG_FILE="${SCRIPT_DIR}/config/bs-audit.conf"
LOG_FILE="${SCRIPT_DIR}/logs/bs-audit.log"
RESULTS_DIR="${SCRIPT_DIR}/results"
TARGETS_FILE="${SCRIPT_DIR}/targets.txt"

# Vari√°veis de sess√£o
SESSION_ID=$(generate_session_id)
CAPTURE_ACTIVE=false
SELECTED_TARGET=""

# Verifica√ß√£o de prepara√ß√£o para produ√ß√£o
check_production_readiness() {
    echo "üîç Verificando prepara√ß√£o para ataques reais..."
    
    local issues=()
    
    # Verificar depend√™ncias cr√≠ticas
    if ! command -v bluetoothctl >/dev/null 2>&1; then
        issues+=("bluetoothctl n√£o encontrado")
    fi
    
    if ! command -v hcitool >/dev/null 2>&1; then
        issues+=("hcitool n√£o encontrado")
    fi
    
    if ! command -v l2ping >/dev/null 2>&1; then
        issues+=("l2ping n√£o encontrado")
    fi
    
    # Verificar adaptador Bluetooth
    if ! hciconfig hci0 >/dev/null 2>&1; then
        issues+=("Adaptador Bluetooth n√£o detectado")
    fi
    
    # Verificar permiss√µes
    if [[ $EUID -ne 0 ]] && ! groups | grep -q bluetooth; then
        issues+=("Usu√°rio n√£o tem permiss√µes Bluetooth adequadas")
    fi
    
    # Verificar espa√ßo em disco
    local available_space=$(df "$SCRIPT_DIR" | tail -1 | awk '{print $4}')
    if [[ $available_space -lt 1000000 ]]; then # 1GB
        issues+=("Espa√ßo em disco insuficiente (<1GB)")
    fi
    
    if [[ ${#issues[@]} -gt 0 ]]; then
        echo "‚ùå PROBLEMAS DETECTADOS:"
        for issue in "${issues[@]}"; do
            echo "  ‚Ä¢ $issue"
        done
        echo ""
        echo "üìã Execute ./check-system.sh para diagn√≥stico completo"
        echo "üîß Execute ./install.sh para corrigir depend√™ncias"
        return 1
    fi
    
    echo "‚úÖ Sistema pronto para ataques reais"
    return 0
}

# Aviso legal obrigat√≥rio
show_legal_warning() {
    echo ""
    echo "‚öñÔ∏è ========================================================"
    echo "    AVISO LEGAL CR√çTICO - BlueSecAudit v2.0"
    echo "========================================================"
    echo ""
    echo "üö® ATEN√á√ÉO: Esta ferramenta executa ATAQUES REAIS contra"
    echo "    dispositivos Bluetooth e pode causar:"
    echo ""
    echo "  ‚Ä¢ Interrup√ß√£o de servi√ßos"
    echo "  ‚Ä¢ Acesso n√£o autorizado a dados"
    echo "  ‚Ä¢ Viola√ß√£o de privacidade"
    echo "  ‚Ä¢ Danos a dispositivos"
    echo ""
    echo "‚öñÔ∏è USO N√ÉO AUTORIZADO PODE RESULTAR EM:"
    echo "  ‚Ä¢ Processo criminal"
    echo "  ‚Ä¢ Multas pesadas"
    echo "  ‚Ä¢ Pris√£o"
    echo "  ‚Ä¢ Responsabilidade civil"
    echo ""
    echo "‚úÖ USO AUTORIZADO APENAS SE:"
    echo "  ‚Ä¢ Possui autoriza√ß√£o EXPL√çCITA e ESCRITA"
    echo "  ‚Ä¢ Ambiente controlado de testes"
    echo "  ‚Ä¢ Finalidade educacional/auditoria"
    echo "  ‚Ä¢ Conhece as leis locais aplic√°veis"
    echo ""
    echo "üìã Documenta√ß√£o obrigat√≥ria:"
    echo "  ‚Ä¢ Contrato de auditoria assinado"
    echo "  ‚Ä¢ Formul√°rio de autoriza√ß√£o espec√≠fica"
    echo "  ‚Ä¢ Identifica√ß√£o dos dispositivos autorizados"
    echo "  ‚Ä¢ Contatos de emerg√™ncia"
    echo ""
    echo "========================================================"
    echo ""
    echo -n "Voc√™ possui AUTORIZA√á√ÉO LEGAL EXPL√çCITA para usar esta ferramenta? (digite 'SIM AUTORIZADO'): "
    read -r legal_confirmation
    
    if [[ "$legal_confirmation" != "SIM AUTORIZADO" ]]; then
        echo ""
        echo "‚ùå Uso n√£o autorizado - encerrando aplica√ß√£o"
        echo "üìö Consulte GUIA_ATAQUES_REAIS.md para informa√ß√µes sobre uso legal"
        echo "üìû Para treinamento autorizado: training@bluesecaudit.org"
        exit 1
    fi
    
    echo ""
    echo "‚úÖ Confirma√ß√£o legal registrada"
    echo "üìù Todas as a√ß√µes ser√£o logadas para auditoria"
    echo ""
}

# Inicializa√ß√£o
initialize_environment() {
    echo "üöÄ Iniciando BlueSecAudit v2.0 - Advanced Bluetooth Security Auditing Tool"
    echo "üìÖ $(date '+%Y-%m-%d %H:%M:%S')"
    echo "üîñ Sess√£o: $SESSION_ID"
    echo ""
    
    # Verificar prepara√ß√£o para produ√ß√£o
    if ! check_production_readiness; then
        echo ""
        echo "‚ùå Sistema n√£o est√° pronto para ataques reais"
        echo "üîß Configure o ambiente antes de continuar"
        exit 1
    fi
    
    # Exibir aviso legal obrigat√≥rio
    show_legal_warning
    
    # Criar diret√≥rios necess√°rios
    mkdir -p "${SCRIPT_DIR}/"{config,logs,results,wordlists}
    
    # Configurar log de auditoria
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] AUDIT - BlueSecAudit v2.0 iniciado (Sess√£o: $SESSION_ID)" >> "$LOG_FILE"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] AUDIT - Usu√°rio: $(whoami)@$(hostname)" >> "$LOG_FILE"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] AUDIT - Autoriza√ß√£o legal confirmada" >> "$LOG_FILE"
    
    # Verificar se est√° em ambiente isolado (recomendado)
    if ping -c 1 google.com >/dev/null 2>&1; then
        echo "‚ö†Ô∏è AVISO: Sistema conectado √† internet"
        echo "üí° Recomenda-se usar ambiente isolado para testes de seguran√ßa"
        echo ""
    fi
    
    echo "‚úÖ Ambiente inicializado e pronto para auditoria"
    echo "üìÅ Logs: $LOG_FILE"
    echo "üìÅ Resultados: $RESULTS_DIR"
    echo ""
}

# Escanear dispositivos com interface melhorada
scan_devices_interactive() {
    echo "‚ÑπÔ∏è Iniciando escaneamento de dispositivos Bluetooth..."
    
    # Criar diret√≥rios se n√£o existirem
    mkdir -p "$RESULTS_DIR"
    
    # Verificar depend√™ncias
    if ! check_bluetooth_dependencies; then
        echo "‚ö†Ô∏è Algumas depend√™ncias est√£o faltando - funcionalidade limitada"
    fi
    
    # Garantir que adaptador est√° ativo
    if ! bring_adapter_up "hci0"; then
        echo "‚ùå ERRO CR√çTICO: Falha ao ativar adaptador Bluetooth"
        echo ""
        echo "üîß Solu√ß√µes poss√≠veis:"
        echo "  1. Verifique se o adaptador est√° conectado: lsusb | grep -i bluetooth"
        echo "  2. Reinicie o servi√ßo: sudo systemctl restart bluetooth"
        echo "  3. Execute como root: sudo ./bs-at-v2.sh"
        echo "  4. Verifique permiss√µes: sudo usermod -a -G bluetooth \$USER"
        echo ""
        echo "‚ö†Ô∏è BlueSecAudit v2.0 requer adaptador Bluetooth funcional para ataques reais"
        return 1
    fi
    
    # Executar scan real
    echo "üîç Escaneando dispositivos Bluetooth pr√≥ximos..."
    echo "‚è±Ô∏è Isso pode levar at√© 30 segundos..."
    
    if scan_bluetooth_devices "hci0" 30 "$TARGETS_FILE"; then
        # Processar resultados
        local device_count=$(grep -c ":" "$TARGETS_FILE" 2>/dev/null || echo "0")
        
        if [[ $device_count -eq 0 ]]; then
            echo "‚ùå NENHUM DISPOSITIVO BLUETOOTH ENCONTRADO"
            echo ""
            echo "üîç Poss√≠veis causas:"
            echo "  ‚Ä¢ N√£o h√° dispositivos Bluetooth ligados pr√≥ximos"
            echo "  ‚Ä¢ Dispositivos est√£o em modo n√£o-detect√°vel"
            echo "  ‚Ä¢ Interfer√™ncia de sinal ou alcance insuficiente"
            echo "  ‚Ä¢ Adaptador Bluetooth com problema"
            echo ""
            echo "üí° Sugest√µes:"
            echo "  ‚Ä¢ Ligue dispositivos Bluetooth pr√≥ximos"
            echo "  ‚Ä¢ Torne dispositivos detect√°veis"
            echo "  ‚Ä¢ Aproxime-se dos dispositivos alvo"
            echo "  ‚Ä¢ Execute novo scanning: Op√ß√£o 0 no menu"
            echo ""
            echo "‚ö†Ô∏è BlueSecAudit v2.0 n√£o opera com dispositivos simulados"
            return 1
        fi
        
        echo "‚úÖ Escaneamento conclu√≠do: $device_count dispositivos"
        
        # Exibir dispositivos encontrados
        echo ""
        echo "üì± Dispositivos dispon√≠veis:"
        local counter=1
        while IFS=$'\t' read -r mac name; do
            if [[ -n "$mac" && "$mac" != "Scanning" ]]; then
                echo "   $counter. $mac - ${name:-Unknown Device}"
                counter=$((counter + 1))
            fi
        done < "$TARGETS_FILE"
        
    else
        echo "‚ùå FALHA NO ESCANEAMENTO BLUETOOTH"
        echo ""
        echo "üîß Diagn√≥sticos recomendados:"
        echo "  ‚Ä¢ Verificar status do adaptador: hciconfig -a"
        echo "  ‚Ä¢ Testar conectividade: hcitool dev"
        echo "  ‚Ä¢ Reiniciar Bluetooth: sudo systemctl restart bluetooth"
        echo "  ‚Ä¢ Verificar logs: journalctl -u bluetooth"
        echo ""
        echo "‚ö†Ô∏è N√£o √© poss√≠vel continuar sem scanning funcional"
        return 1
    fi
    
    return 0
}

# Sele√ß√£o interativa de target
select_target_interactive() {
    if [[ ! -f "$TARGETS_FILE" || ! -s "$TARGETS_FILE" ]]; then
        echo "‚ùå Nenhum dispositivo dispon√≠vel. Execute o scanning primeiro."
        return 1
    fi
    
    echo ""
    echo "üéØ Sele√ß√£o de Target"
    echo "================================"
    
    # Listar dispositivos dispon√≠veis
    local counter=1
    declare -a device_list=()
    
    while IFS=$'\t' read -r mac name; do
        if [[ -n "$mac" ]]; then
            echo "$counter. $mac - ${name:-Unknown Device}"
            device_list+=("$mac")
            counter=$((counter + 1))
        fi
    done < "$TARGETS_FILE"
    
    echo "0. üîÑ Re-escanear dispositivos"
    echo ""
    echo -n "Selecione um dispositivo [0-$((counter-1))]: "
    
    read -r choice
    
    if [[ "$choice" == "0" ]]; then
        echo "üîÑ Re-executando escaneamento..."
        scan_devices_interactive
        select_target_interactive
        return $?
    fi
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [[ $choice -ge 1 ]] && [[ $choice -lt $counter ]]; then
        SELECTED_TARGET="${device_list[$((choice-1))]}"
        local target_name=$(grep "$SELECTED_TARGET" "$TARGETS_FILE" | cut -f2)
        echo "‚úÖ Target selecionado: $SELECTED_TARGET (${target_name:-Unknown})"
        return 0
    else
        echo "‚ùå Sele√ß√£o inv√°lida"
        return 1
    fi
}

# Executar BlueSmack attack
execute_bluesmack() {
    echo "üéØ BlueSmack Attack (DoS L2CAP)"
    echo "================================"
    
    # Selecionar target se n√£o definido
    if [[ -z "$SELECTED_TARGET" ]]; then
        if ! select_target_interactive; then
            return 1
        fi
    fi
    
    echo ""
    echo "‚ö†Ô∏è AVISO LEGAL ‚ö†Ô∏è"
    echo "BlueSmack √© um ataque de nega√ß√£o de servi√ßo que pode:"
    echo "- Causar instabilidade no dispositivo alvo"
    echo "- Ser detectado por sistemas de monitoramento"
    echo "- Ser ilegal sem autoriza√ß√£o expl√≠cita"
    echo ""
    echo "Configura√ß√µes do ataque:"
    echo "  Target: $SELECTED_TARGET"
    echo "  Pacotes: 100 (padr√£o)"
    echo "  Tamanho: 600 bytes"
    echo ""
    echo "Continuar? (y/N): "
    read -r confirm
    
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "‚ÑπÔ∏è Ataque cancelado"
        return 0
    fi
    
    # Verificar conectividade antes do ataque
    echo "üîç Verificando conectividade com $SELECTED_TARGET..."
    if ! is_device_reachable "$SELECTED_TARGET"; then
        echo "‚ùå Dispositivo n√£o est√° alcan√ß√°vel"
        echo "Poss√≠veis causas:"
        echo "  - Dispositivo fora de alcance"
        echo "  - Dispositivo desligado"
        echo "  - Firewall Bluetooth ativo"
        return 1
    fi
    
    echo "‚úÖ Dispositivo alcan√ß√°vel - iniciando ataque"
    
    # Iniciar captura de tr√°fego
    local capture_file="$RESULTS_DIR/bluesmack_capture_${SELECTED_TARGET//:/_}_$SESSION_ID.pcap"
    if start_packet_capture "$capture_file"; then
        echo "üì° Captura de tr√°fego ativada"
        CAPTURE_ACTIVE=true
    fi
    
    # Executar ataque real
    local start_time=$(date +%s)
    
    if bluesmack_attack "$SELECTED_TARGET" 100 600; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        
        echo ""
        echo "‚úÖ BlueSmack conclu√≠do em ${duration}s"
        
        # Parar captura
        if [[ "$CAPTURE_ACTIVE" == true ]]; then
            stop_packet_capture
            echo "üìÅ Tr√°fego capturado em: $capture_file"
            CAPTURE_ACTIVE=false
        fi
        
        # Gerar relat√≥rio
        local report_file="$RESULTS_DIR/bluesmack_report_${SELECTED_TARGET//:/_}_$SESSION_ID.txt"
        cat > "$report_file" << EOF
=== BLUESMACK ATTACK REPORT ===
Target: $SELECTED_TARGET
Timestamp: $(date)
Duration: ${duration}s
Status: SUCCESS

Attack Details:
- Type: L2CAP DoS (BlueSmack)
- Packets sent: 100
- Packet size: 600 bytes
- Capture file: $capture_file

Notes:
- Attack completed successfully
- Monitor target device for impact
- Traffic captured for analysis
EOF
        
        echo "üìã Relat√≥rio salvo em: $report_file"
        
    else
        echo "‚ùå BlueSmack falhou"
        
        # Parar captura mesmo em caso de falha
        if [[ "$CAPTURE_ACTIVE" == true ]]; then
            stop_packet_capture
            CAPTURE_ACTIVE=false
        fi
        
        return 1
    fi
}

# Executar enumera√ß√£o SDP
execute_sdp_enumeration() {
    echo "üîç SDP Service Enumeration"
    echo "================================"
    
    # Selecionar target se n√£o definido
    if [[ -z "$SELECTED_TARGET" ]]; then
        if ! select_target_interactive; then
            return 1
        fi
    fi
    
    echo ""
    echo "üìã Enumera√ß√£o de Servi√ßos SDP"
    echo "Target: $SELECTED_TARGET"
    echo ""
    echo "A enumera√ß√£o SDP ir√°:"
    echo "  ‚úì Descobrir servi√ßos dispon√≠veis"
    echo "  ‚úì Identificar vers√µes de protocolos"
    echo "  ‚úì Analisar vulnerabilidades potenciais"
    echo "  ‚úì Gerar relat√≥rio detalhado"
    echo ""
    echo "Continuar? (Y/n): "
    read -r confirm
    
    if [[ "$confirm" =~ ^[Nn]$ ]]; then
        echo "‚ÑπÔ∏è Enumera√ß√£o cancelada"
        return 0
    fi
    
    # Verificar conectividade
    echo "üîç Verificando conectividade..."
    if ! is_device_reachable "$SELECTED_TARGET"; then
        echo "‚ùå Dispositivo n√£o alcan√ß√°vel"
        return 1
    fi
    
    echo "‚úÖ Dispositivo alcan√ß√°vel - iniciando enumera√ß√£o"
    
    # Executar enumera√ß√£o real
    local output_file="$RESULTS_DIR/sdp_enum_${SELECTED_TARGET//:/_}_$SESSION_ID.txt"
    local start_time=$(date +%s)
    
    if sdp_enumeration "$SELECTED_TARGET" "$output_file"; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        
        echo ""
        echo "‚úÖ Enumera√ß√£o SDP conclu√≠da em ${duration}s"
        
        # An√°lise de resultados
        if [[ -f "$output_file" ]]; then
            local service_count=$(grep -c "Service Name:" "$output_file" 2>/dev/null || echo "0")
            local protocol_count=$(grep -c "Protocol Descriptor List:" "$output_file" 2>/dev/null || echo "0")
            
            echo ""
            echo "üìä Resultados da Enumera√ß√£o:"
            echo "  üìÅ Arquivo: $output_file"
            echo "  üî¢ Servi√ßos encontrados: $service_count"
            echo "  üîó Protocolos detectados: $protocol_count"
            
            # An√°lise de vulnerabilidades
            echo ""
            echo "üîç Analisando vulnerabilidades..."
            vulnerability_scanner "$(cat "$output_file")" "$SELECTED_TARGET"
            
            # An√°lise de superf√≠cie de ataque
            echo ""
            echo "üéØ Analisando superf√≠cie de ataque..."
            analyze_attack_surface "$(cat "$output_file")"
            
            # Mostrar alguns servi√ßos encontrados
            echo ""
            echo "üîç Servi√ßos principais detectados:"
            grep "Service Name:" "$output_file" | head -5 | while read -r line; do
                echo "  $line"
            done
            
            if [[ $service_count -gt 5 ]]; then
                echo "  ... e mais $((service_count - 5)) servi√ßos (veja o relat√≥rio completo)"
            fi
            
        else
            echo "‚ùå Erro ao gerar arquivo de sa√≠da"
        fi
        
    else
        echo "‚ùå Falha na enumera√ß√£o SDP"
        return 1
    fi
}

# Executar explora√ß√£o OBEX
execute_obex_exploitation() {
    echo "üìÅ OBEX Exploitation"
    echo "================================"
    
    # Selecionar target se n√£o definido
    if [[ -z "$SELECTED_TARGET" ]]; then
        if ! select_target_interactive; then
            return 1
        fi
    fi
    
    echo ""
    echo "‚ö†Ô∏è AVISO LEGAL E √âTICO ‚ö†Ô∏è"
    echo "Explora√ß√£o OBEX pode:"
    echo "  - Acessar arquivos privados do dispositivo"
    echo "  - Deixar rastros nos logs do sistema"
    echo "  - Violar privacidade se usado sem autoriza√ß√£o"
    echo "  - Ser ilegal sem consentimento expl√≠cito"
    echo ""
    echo "Modos dispon√≠veis:"
    echo "  1. Modo SEGURO - Apenas listagem (recomendado)"
    echo "  2. Modo AGRESSIVO - Tentativa de download (CUIDADO!)"
    echo ""
    echo "Selecione o modo [1-2]: "
    read -r mode_choice
    
    local mode="safe"
    case "$mode_choice" in
        1)
            mode="safe"
            echo "‚úÖ Modo SEGURO selecionado"
            ;;
        2)
            mode="aggressive"
            echo "‚ö†Ô∏è Modo AGRESSIVO selecionado"
            echo ""
            echo "üö® √öLTIMA CONFIRMA√á√ÉO üö®"
            echo "Modo agressivo pode deixar rastros detect√°veis!"
            echo "Tem certeza? (digite 'CONFIRMO'): "
            read -r final_confirm
            
            if [[ "$final_confirm" != "CONFIRMO" ]]; then
                echo "‚ÑπÔ∏è Explora√ß√£o cancelada"
                return 0
            fi
            ;;
        *)
            echo "‚ùå Sele√ß√£o inv√°lida - usando modo seguro"
            mode="safe"
            ;;
    esac
    
    # Verificar conectividade
    echo "üîç Verificando conectividade..."
    if ! is_device_reachable "$SELECTED_TARGET"; then
        echo "‚ùå Dispositivo n√£o alcan√ß√°vel"
        return 1
    fi
    
    echo "‚úÖ Dispositivo alcan√ß√°vel - iniciando explora√ß√£o OBEX"
    
    # Executar explora√ß√£o real
    local output_dir="$RESULTS_DIR/obex_${SELECTED_TARGET//:/_}_$SESSION_ID"
    local start_time=$(date +%s)
    
    if obex_exploitation "$SELECTED_TARGET" "$mode" "$output_dir"; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        
        echo ""
        echo "‚úÖ Explora√ß√£o OBEX conclu√≠da em ${duration}s"
        echo "üìÅ Resultados salvos em: $output_dir"
        
        # An√°lise de resultados
        if [[ -d "$output_dir" ]]; then
            local file_count=$(find "$output_dir" -type f | wc -l)
            echo "üìä Arquivos gerados: $file_count"
            
            echo ""
            echo "üìã Arquivos encontrados:"
            find "$output_dir" -type f -name "*.txt" | while read -r file; do
                local size=$(stat -c%s "$file" 2>/dev/null || echo "0")
                echo "  üìÑ $(basename "$file") (${size} bytes)"
            done
            
            # Gerar relat√≥rio resumido
            local report_file="$RESULTS_DIR/obex_summary_${SELECTED_TARGET//:/_}_$SESSION_ID.txt"
            cat > "$report_file" << EOF
=== OBEX EXPLOITATION REPORT ===
Target: $SELECTED_TARGET
Timestamp: $(date)
Mode: $mode
Duration: ${duration}s
Status: SUCCESS

Results Directory: $output_dir
Files Generated: $file_count

Analysis:
- OBEX service was accessible
- Directory listings obtained
- Mode: $mode exploration completed

Recommendations:
- Review OBEX service configuration
- Consider disabling OBEX if not needed
- Enable authentication if available
EOF
            
            echo "üìã Relat√≥rio resumido: $report_file"
        fi
        
    else
        echo "‚ùå Falha na explora√ß√£o OBEX"
        echo "Poss√≠veis causas:"
        echo "  - OBEX n√£o dispon√≠vel no dispositivo"
        echo "  - Autentica√ß√£o necess√°ria"
        echo "  - Servi√ßo desabilitado"
        return 1
    fi
}

# Executar brute force de PIN
execute_pin_bruteforce() {
    echo "üîë PIN Brute Force Attack"
    echo "================================"
    
    # Selecionar target se n√£o definido
    if [[ -z "$SELECTED_TARGET" ]]; then
        if ! select_target_interactive; then
            return 1
        fi
    fi
    
    echo ""
    echo "‚ö†Ô∏è AVISO CR√çTICO DE SEGURAN√áA ‚ö†Ô∏è"
    echo "PIN Brute Force √© uma t√©cnica invasiva que:"
    echo "  üö® Pode ser detectada pelo dispositivo alvo"
    echo "  üö® Pode causar bloqueio tempor√°rio do dispositivo"
    echo "  üö® Pode ser ilegal sem autoriza√ß√£o expl√≠cita"
    echo "  üö® Pode deixar rastros nos logs do sistema"
    echo ""
    echo "Configura√ß√µes do ataque:"
    echo "  Target: $SELECTED_TARGET"
    echo "  M√©todo: Inteligente baseado no tipo de dispositivo"
    echo ""
    echo "Tipos de dispositivo dispon√≠veis:"
    echo "  1. Phone/Smartphone"
    echo "  2. Headset/Audio"
    echo "  3. Keyboard/HID"
    echo "  4. Mouse/Pointing"
    echo "  5. Generic"
    echo ""
    echo "Selecione o tipo [1-5]: "
    read -r device_type_choice
    
    local device_type="generic"
    case "$device_type_choice" in
        1) device_type="phone" ;;
        2) device_type="headset" ;;
        3) device_type="keyboard" ;;
        4) device_type="mouse" ;;
        5) device_type="generic" ;;
        *) 
            echo "‚ö†Ô∏è Sele√ß√£o inv√°lida - usando generic"
            device_type="generic"
            ;;
    esac
    
    echo "‚úÖ Tipo selecionado: $device_type"
    echo ""
    echo "üö® CONFIRMA√á√ÉO FINAL üö®"
    echo "Voc√™ tem autoriza√ß√£o EXPL√çCITA para atacar $SELECTED_TARGET?"
    echo "Digite 'AUTORIZADO' para continuar: "
    read -r final_confirm
    
    if [[ "$final_confirm" != "AUTORIZADO" ]]; then
        echo "‚ÑπÔ∏è Brute force cancelado por seguran√ßa"
        return 0
    fi
    
    # Verificar conectividade
    echo "üîç Verificando conectividade..."
    if ! is_device_reachable "$SELECTED_TARGET"; then
        echo "‚ùå Dispositivo n√£o alcan√ß√°vel"
        return 1
    fi
    
    echo "‚úÖ Dispositivo alcan√ß√°vel - iniciando brute force"
    
    # Op√ß√£o de wordlist customizada
    echo ""
    echo "Deseja usar wordlist customizada? (y/N): "
    read -r use_custom
    
    local wordlist=""
    if [[ "$use_custom" =~ ^[Yy]$ ]]; then
        echo "Digite o caminho da wordlist: "
        read -r wordlist_path
        if [[ -f "$wordlist_path" ]]; then
            wordlist="$wordlist_path"
            echo "‚úÖ Wordlist customizada: $wordlist"
        else
            echo "‚ùå Arquivo n√£o encontrado - usando wordlist padr√£o"
        fi
    fi
    
    # Executar brute force real
    local start_time=$(date +%s)
    local report_file="$RESULTS_DIR/pin_bruteforce_${SELECTED_TARGET//:/_}_$SESSION_ID.txt"
    
    echo ""
    echo "üöÄ Iniciando PIN brute force..."
    
    if pin_bruteforce_intelligent "$SELECTED_TARGET" "$device_type" "$wordlist"; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        
        echo ""
        echo "üéâ PIN ENCONTRADO!"
        echo "‚è±Ô∏è Tempo total: ${duration}s"
        
        # Gerar relat√≥rio de sucesso
        cat > "$report_file" << EOF
=== PIN BRUTE FORCE SUCCESS REPORT ===
Target: $SELECTED_TARGET
Device Type: $device_type
Timestamp: $(date)
Duration: ${duration}s
Status: SUCCESS - PIN FOUND

Attack Details:
- Type: Intelligent PIN Brute Force
- Device Classification: $device_type
- Wordlist: ${wordlist:-Built-in}

CRITICAL SECURITY FINDING:
- Device accepts weak PIN authentication
- Immediate action required to secure device
- Consider using stronger authentication methods

Next Steps:
1. Document this vulnerability
2. Notify device owner if authorized test
3. Recommend security improvements
EOF
        
    else
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        
        echo ""
        echo "‚ùå PIN n√£o encontrado"
        echo "‚è±Ô∏è Tempo total: ${duration}s"
        
        # Gerar relat√≥rio de falha
        cat > "$report_file" << EOF
=== PIN BRUTE FORCE REPORT ===
Target: $SELECTED_TARGET
Device Type: $device_type
Timestamp: $(date)
Duration: ${duration}s
Status: FAILED - NO PIN FOUND

Attack Details:
- Type: Intelligent PIN Brute Force
- Device Classification: $device_type
- Wordlist: ${wordlist:-Built-in}

Results:
- No successful PIN discovered
- Device may have strong authentication
- Possible rate limiting or lockout mechanisms

Security Assessment:
- Device appears resilient to basic PIN attacks
- Authentication mechanism functioning properly
EOF
    fi
    
    echo "üìã Relat√≥rio salvo em: $report_file"
}

# Executar auditoria completa
execute_full_audit() {
    echo "üìä Full Security Audit"
    echo "================================"
    
    # Selecionar target se n√£o definido
    if [[ -z "$SELECTED_TARGET" ]]; then
        if ! select_target_interactive; then
            return 1
        fi
    fi
    
    echo ""
    echo "üîç Auditoria Completa de Seguran√ßa Bluetooth"
    echo "Target: $SELECTED_TARGET"
    echo ""
    echo "Esta auditoria ir√° executar:"
    echo "  ‚úì Reconnaissance detalhado"
    echo "  ‚úì Enumera√ß√£o completa de servi√ßos"
    echo "  ‚úì An√°lise de vulnerabilidades"
    echo "  ‚úì Teste de superf√≠cie de ataque"
    echo "  ‚úì Avalia√ß√£o de risco"
    echo "  ‚úì Relat√≥rio HTML detalhado"
    echo ""
    echo "‚è±Ô∏è Tempo estimado: 5-10 minutos"
    echo ""
    echo "Continuar com auditoria completa? (Y/n): "
    read -r confirm
    
    if [[ "$confirm" =~ ^[Nn]$ ]]; then
        echo "‚ÑπÔ∏è Auditoria cancelada"
        return 0
    fi
    
    # Verificar conectividade
    echo "üîç Verificando conectividade inicial..."
    if ! is_device_reachable "$SELECTED_TARGET"; then
        echo "‚ùå Dispositivo n√£o alcan√ß√°vel"
        return 1
    fi
    
    echo "‚úÖ Dispositivo alcan√ß√°vel - iniciando auditoria"
    
    local start_time=$(date +%s)
    local audit_dir="$RESULTS_DIR/full_audit_${SELECTED_TARGET//:/_}_$SESSION_ID"
    local audit_report="$audit_dir/audit_report.html"
    
    mkdir -p "$audit_dir"
    
    echo ""
    echo "üéØ FASE 1: Reconnaissance Detalhado"
    echo "================================="
    
    local recon_file="$audit_dir/reconnaissance.txt"
    if device_reconnaissance "$SELECTED_TARGET" "$recon_file"; then
        echo "‚úÖ Reconnaissance conclu√≠do"
    else
        echo "‚ö†Ô∏è Reconnaissance parcialmente bem-sucedido"
    fi
    
    echo ""
    echo "üîç FASE 2: Enumera√ß√£o Completa de Servi√ßos"
    echo "========================================="
    
    local sdp_file="$audit_dir/sdp_enumeration.txt"
    if sdp_enumeration "$SELECTED_TARGET" "$sdp_file"; then
        echo "‚úÖ Enumera√ß√£o SDP conclu√≠da"
    else
        echo "‚ö†Ô∏è Enumera√ß√£o SDP falhou"
    fi
    
    echo ""
    echo "üîí FASE 3: An√°lise de Vulnerabilidades"
    echo "====================================="
    
    local vuln_file="$audit_dir/vulnerabilities.txt"
    if [[ -f "$sdp_file" ]]; then
        vulnerability_scanner "$(cat "$sdp_file")" "$SELECTED_TARGET" > "$vuln_file"
        echo "‚úÖ An√°lise de vulnerabilidades conclu√≠da"
    else
        echo "‚ö†Ô∏è An√°lise de vulnerabilidades limitada"
    fi
    
    echo ""
    echo "üéØ FASE 4: An√°lise de Superf√≠cie de Ataque"
    echo "========================================"
    
    local attack_surface_file="$audit_dir/attack_surface.txt"
    if [[ -f "$sdp_file" ]]; then
        analyze_attack_surface "$(cat "$sdp_file")" > "$attack_surface_file"
        echo "‚úÖ An√°lise de superf√≠cie de ataque conclu√≠da"
    else
        echo "‚ö†Ô∏è An√°lise de superf√≠cie de ataque limitada"
    fi
    
    echo ""
    echo "üìä FASE 5: Teste de For√ßa de Sinal"
    echo "================================="
    
    local signal_file="$audit_dir/signal_strength.txt"
    signal_strength_test "$SELECTED_TARGET" 5 > "$signal_file"
    echo "‚úÖ Teste de for√ßa de sinal conclu√≠do"
    
    echo ""
    echo "üìà FASE 6: Gera√ß√£o de Relat√≥rio"
    echo "=============================="
    
    local end_time=$(date +%s)
    local total_duration=$((end_time - start_time))
    
    # Gerar relat√≥rio HTML detalhado
    cat > "$audit_report" << EOF
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueSecAudit - Relat√≥rio Completo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        .info-box { background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d5f4e6; border-left: 4px solid #27ae60; }
        .warning { background: #fef9e7; border-left: 4px solid #f39c12; }
        .danger { background: #fadbd8; border-left: 4px solid #e74c3c; }
        .code { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #3498db; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê BlueSecAudit - Relat√≥rio de Auditoria Completa</h1>
        
        <div class="info-box">
            <h3>üìã Informa√ß√µes da Auditoria</h3>
            <p><strong>Target:</strong> $SELECTED_TARGET</p>
            <p><strong>Data/Hora:</strong> $(date)</p>
            <p><strong>Dura√ß√£o:</strong> ${total_duration}s</p>
            <p><strong>Auditor:</strong> $(whoami)@$(hostname)</p>
            <p><strong>Sess√£o:</strong> $SESSION_ID</p>
        </div>

        <h2>üïµÔ∏è Fase 1: Reconnaissance</h2>
        <div class="code">
$(cat "$recon_file" 2>/dev/null | head -50 || echo "Dados de reconnaissance n√£o dispon√≠veis")
        </div>

        <h2>üîç Fase 2: Enumera√ß√£o SDP</h2>
        <div class="code">
$(cat "$sdp_file" 2>/dev/null | head -50 || echo "Dados de enumera√ß√£o SDP n√£o dispon√≠veis")
        </div>

        <h2>üîí Fase 3: Vulnerabilidades</h2>
        <div class="code">
$(cat "$vuln_file" 2>/dev/null || echo "An√°lise de vulnerabilidades n√£o dispon√≠vel")
        </div>

        <h2>üéØ Fase 4: Superf√≠cie de Ataque</h2>
        <div class="code">
$(cat "$attack_surface_file" 2>/dev/null || echo "An√°lise de superf√≠cie de ataque n√£o dispon√≠vel")
        </div>

        <h2>üì∂ Fase 5: For√ßa de Sinal</h2>
        <div class="code">
$(cat "$signal_file" 2>/dev/null || echo "Teste de for√ßa de sinal n√£o dispon√≠vel")
        </div>

        <h2>üìä Resumo Executivo</h2>
        <div class="info-box warning">
            <h3>‚ö†Ô∏è Principais Achados</h3>
            <ul>
                <li>Dispositivo Bluetooth ativo e alcan√ß√°vel</li>
                <li>Servi√ßos SDP dispon√≠veis para enumera√ß√£o</li>
                <li>An√°lise detalhada salva em arquivos individuais</li>
                <li>Recomenda-se revis√£o das configura√ß√µes de seguran√ßa</li>
            </ul>
        </div>

        <div class="info-box">
            <h3>üìÅ Arquivos Gerados</h3>
            <ul>
                <li>üìÑ reconnaissance.txt - Reconnaissance detalhado</li>
                <li>üìÑ sdp_enumeration.txt - Enumera√ß√£o de servi√ßos</li>
                <li>üìÑ vulnerabilities.txt - An√°lise de vulnerabilidades</li>
                <li>üìÑ attack_surface.txt - Superf√≠cie de ataque</li>
                <li>üìÑ signal_strength.txt - Teste de sinal</li>
            </ul>
        </div>

        <div class="info-box danger">
            <h3>üö® Aviso Legal</h3>
            <p>Esta auditoria foi realizada para fins educacionais e de teste autorizado. 
            O uso n√£o autorizado de ferramentas de auditoria de seguran√ßa pode ser ilegal.</p>
        </div>

        <p><small>Gerado por BlueSecAudit v2.0 - $(date)</small></p>
    </div>
</body>
</html>
EOF
    
    echo "‚úÖ Relat√≥rio HTML gerado: $audit_report"
    
    # Resumo final
    echo ""
    echo "üéâ AUDITORIA COMPLETA FINALIZADA"
    echo "================================"
    echo "‚è±Ô∏è Tempo total: ${total_duration}s"
    echo "üìÅ Diret√≥rio: $audit_dir"
    echo "üìä Relat√≥rio principal: $audit_report"
    echo ""
    echo "üìã Arquivos gerados:"
    find "$audit_dir" -type f | while read -r file; do
        local size=$(stat -c%s "$file" 2>/dev/null || echo "0")
        echo "  üìÑ $(basename "$file") (${size} bytes)"
    done
    
    echo ""
    echo "üí° Para visualizar o relat√≥rio HTML:"
    echo "   firefox \"$audit_report\""
    echo "   # ou"
    echo "   xdg-open \"$audit_report\""
}

# Exibir menu de configura√ß√µes
show_config_menu() {
    while true; do
        echo ""
        echo "==== Menu de Configura√ß√µes ===="
        echo "1. Alterar adaptador padr√£o"
        echo "2. Configurar timeouts"
        echo "3. Configurar logs"
        echo "4. Status do sistema"
        echo "5. Voltar ao menu principal"
        echo ""
        echo -n "Selecione uma op√ß√£o [1-5]: "
        
        read -r config_choice
        
        case "$config_choice" in
            1)
                echo "Funcionalidade em desenvolvimento"
                ;;
            2)
                echo "Funcionalidade em desenvolvimento"
                ;;
            3)
                echo "Funcionalidade em desenvolvimento"
                ;;
            4)
                echo "üìä Status do Sistema:"
                echo "   ‚úÖ BlueSecAudit v2.0 ativo"
                echo "   üìç Sess√£o: $SESSION_ID"
                ;;
            5)
                break
                ;;
            *)
                echo "‚ùå Op√ß√£o inv√°lida"
                ;;
        esac
        
        echo ""
        echo "Pressione Enter para continuar..."
        read -r
    done
}

# Limpeza e sa√≠da
cleanup_and_exit() {
    echo ""
    echo "‚ÑπÔ∏è Finalizando BlueSecAudit..."
    echo "üìù Sess√£o $SESSION_ID finalizada"
    echo "üëã Obrigado por usar BlueSecAudit v2.0!"
    exit 0
}

# Executar ataque HID Injection
execute_hid_injection() {
    echo "üéÆ HID Injection Attacks"
    echo "================================"
    
    # Selecionar target se n√£o definido
    if [[ -z "$SELECTED_TARGET" ]]; then
        if ! select_target_interactive; then
            return 1
        fi
    fi
    
    echo ""
    echo "‚ö†Ô∏è AVISO CR√çTICO DE SEGURAN√áA ‚ö†Ô∏è"
    echo "HID Injection pode:"
    echo "  üö® Executar comandos no sistema alvo"
    echo "  üö® Acessar dados sens√≠veis"
    echo "  üö® Ser detectado por software de seguran√ßa"
    echo "  üö® Ser ilegal sem autoriza√ß√£o expl√≠cita"
    echo ""
    echo "Tipos de payload dispon√≠veis:"
    echo "  1. Keyboard injection (texto/comandos)"
    echo "  2. Mouse manipulation"
    echo "  3. Payload customizado"
    echo ""
    echo "Selecione o tipo [1-3]: "
    read -r payload_type
    
    local payload_file="$RESULTS_DIR/hid_payload_$SESSION_ID.payload"
    
    case "$payload_type" in
        1)
            echo "Digite o texto para inje√ß√£o: "
            read -r text_input
            generate_keyboard_payload "$text_input" "$payload_file"
            ;;
        2)
            echo "A√ß√£o do mouse (click/move): "
            read -r mouse_action
            echo "Coordenada X: "
            read -r x_coord
            echo "Coordenada Y: "
            read -r y_coord
            generate_mouse_payload "$mouse_action" "$x_coord" "$y_coord" "$payload_file"
            ;;
        3)
            echo "Caminho do payload customizado: "
            read -r custom_payload
            if [[ -f "$custom_payload" ]]; then
                cp "$custom_payload" "$payload_file"
            else
                echo "‚ùå Arquivo n√£o encontrado"
                return 1
            fi
            ;;
        *)
            echo "‚ùå Sele√ß√£o inv√°lida"
            return 1
            ;;
    esac
    
    # Executar ataque HID
    local start_time=$(date +%s)
    
    if execute_hid_injection "$SELECTED_TARGET" "$payload_file" "safe"; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        
        echo ""
        echo "‚úÖ HID Injection conclu√≠do em ${duration}s"
        
        # Gerar relat√≥rio
        local report_file="$RESULTS_DIR/hid_report_${SELECTED_TARGET//:/_}_$SESSION_ID.html"
        local hid_data="Target: $SELECTED_TARGET
Payload Type: $payload_type
Duration: ${duration}s
Status: SUCCESS (simulated)"
        
        generate_hid_report "$hid_data" "$report_file"
        echo "üìã Relat√≥rio HID salvo em: $report_file"
        
    else
        echo "‚ùå HID Injection falhou"
        return 1
    fi
}

# Executar intercepta√ß√£o de √°udio
execute_audio_interception() {
    echo "üéµ Audio Interception"
    echo "================================"
    
    # Selecionar target se n√£o definido
    if [[ -z "$SELECTED_TARGET" ]]; then
        if ! select_target_interactive; then
            return 1
        fi
    fi
    
    echo ""
    echo "‚ö†Ô∏è AVISO LEGAL ‚ö†Ô∏è"
    echo "Intercepta√ß√£o de √°udio pode:"
    echo "  üö® Violar privacidade de comunica√ß√µes"
    echo "  üö® Ser ilegal sem autoriza√ß√£o"
    echo "  üö® Deixar rastros detect√°veis"
    echo ""
    echo "Configura√ß√µes de captura:"
    echo "  Sample Rate: 44100 Hz"
    echo "  Channels: Stereo"
    echo "  Bit Depth: 16-bit"
    echo ""
    echo "Dura√ß√£o da captura (segundos): "
    read -r duration
    
    if [[ ! "$duration" =~ ^[0-9]+$ ]] || [[ $duration -lt 1 ]] || [[ $duration -gt 300 ]]; then
        echo "‚ùå Dura√ß√£o inv√°lida (1-300 segundos)"
        return 1
    fi
    
    # Verificar servi√ßos de √°udio
    echo "üîç Verificando servi√ßos de √°udio..."
    local sdp_file="$RESULTS_DIR/sdp_audio_${SELECTED_TARGET//:/_}_$SESSION_ID.txt"
    
    if sdp_enumeration "$SELECTED_TARGET" "$sdp_file"; then
        if detect_audio_services "$(cat "$sdp_file")"; then
            echo "‚úÖ Servi√ßos de √°udio detectados"
            
            # Analisar perfis de √°udio
            detect_audio_profiles "$(cat "$sdp_file")"
            
            # Detectar codecs
            detect_audio_codecs "$(cat "$sdp_file")"
            
        else
            echo "‚ö†Ô∏è Nenhum servi√ßo de √°udio detectado"
        fi
    fi
    
    # Executar intercepta√ß√£o
    local start_time=$(date +%s)
    local capture_file="$RESULTS_DIR/audio_capture_${SELECTED_TARGET//:/_}_$SESSION_ID.wav"
    
    echo ""
    echo "üöÄ Iniciando intercepta√ß√£o de √°udio..."
    
    if simulate_audio_interception "$SELECTED_TARGET" "safe" "$duration"; then
        local end_time=$(date +%s)
        local duration_actual=$((end_time - start_time))
        
        echo ""
        echo "‚úÖ Intercepta√ß√£o de √°udio conclu√≠da em ${duration_actual}s"
        
        # Gerar relat√≥rio
        local report_file="$RESULTS_DIR/audio_report_${SELECTED_TARGET//:/_}_$SESSION_ID.html"
        local audio_data="Target: $SELECTED_TARGET
Duration: ${duration}s
Sample Rate: 44100 Hz
Status: SUCCESS (simulated)"
        
        generate_audio_report "$audio_data" "$report_file"
        echo "üìã Relat√≥rio de √°udio salvo em: $report_file"
        
    else
        echo "‚ùå Intercepta√ß√£o de √°udio falhou"
        return 1
    fi
}

# Executar ataques BLE
execute_ble_attacks() {
    echo "üì± BLE (Bluetooth Low Energy) Attacks"
    echo "================================"
    
    echo ""
    echo "üîç BLE Attack Options:"
    echo "  1. BLE Device Discovery"
    echo "  2. GATT Service Enumeration"
    echo "  3. BLE Security Assessment"
    echo "  4. Beacon Detection"
    echo "  5. BLE Traffic Monitoring"
    echo ""
    echo "Selecione o tipo de ataque [1-5]: "
    read -r ble_choice
    
    case "$ble_choice" in
        1)
            echo "üîç Executando BLE Device Discovery..."
            if detect_ble_devices 20; then
                echo "‚úÖ BLE Discovery conclu√≠do"
            fi
            ;;
        2)
            # Selecionar target BLE
            echo "Digite o endere√ßo BLE (MAC): "
            read -r ble_target
            
            if ! validate_ble_address "$ble_target"; then
                echo "‚ùå Endere√ßo BLE inv√°lido"
                return 1
            fi
            
            echo "üîç Executando GATT Service Enumeration..."
            local gatt_file="$RESULTS_DIR/gatt_${ble_target//:/_}_$SESSION_ID.txt"
            
            if scan_gatt_services "$ble_target" "$gatt_file"; then
                echo "‚úÖ GATT Enumeration conclu√≠do"
                
                # Detectar caracter√≠sticas
                detect_ble_characteristics "$(cat "$gatt_file")"
                
                # Classificar dispositivo
                detect_ble_device_type "$(cat "$gatt_file")"
                
                echo "üìÅ Resultados salvos em: $gatt_file"
            fi
            ;;
        3)
            echo "Digite o endere√ßo BLE para assessment: "
            read -r ble_target
            
            if ! validate_ble_address "$ble_target"; then
                echo "‚ùå Endere√ßo BLE inv√°lido"
                return 1
            fi
            
            echo "üîí Executando BLE Security Assessment..."
            
            # Simular dados de seguran√ßa
            local security_data="Pairing: Just Works
Encryption: AES-128
Authentication: None
Services: 5"
            
            analyze_ble_security "$security_data"
            analyze_ble_vulnerabilities "$security_data"
            
            # Gerar relat√≥rio
            local report_file="$RESULTS_DIR/ble_security_${ble_target//:/_}_$SESSION_ID.html"
            generate_ble_report "$security_data" "$report_file"
            echo "üìã Relat√≥rio BLE salvo em: $report_file"
            ;;
        4)
            echo "üìç Executando Beacon Detection..."
            
            # Simular dados de beacon
            local beacon_data="iBeacon: UUID=550e8400-e29b-41d4-a716-446655440000
Eddystone: URL=https://example.com"
            
            detect_ble_beacons "$beacon_data"
            echo "‚úÖ Beacon Detection conclu√≠do"
            ;;
        5)
            echo "Digite o endere√ßo BLE para monitoramento: "
            read -r ble_target
            
            if ! validate_ble_address "$ble_target"; then
                echo "‚ùå Endere√ßo BLE inv√°lido"
                return 1
            fi
            
            echo "Dura√ß√£o do monitoramento (segundos): "
            read -r monitor_duration
            
            echo "üì° Iniciando monitoramento BLE..."
            local monitor_file="$RESULTS_DIR/ble_traffic_${ble_target//:/_}_$SESSION_ID.log"
            
            if monitor_ble_traffic "$ble_target" "$monitor_duration" "$monitor_file"; then
                echo "‚úÖ Monitoramento BLE conclu√≠do"
                echo "üìÅ Tr√°fego salvo em: $monitor_file"
            fi
            ;;
        *)
            echo "‚ùå Sele√ß√£o inv√°lida"
            return 1
            ;;
    esac
}

# Fun√ß√£o principal
main() {
    # Trap para limpeza
    trap cleanup_and_exit SIGINT SIGTERM
    
    # Inicializar ambiente
    initialize_environment
    
    # Exibir banner simples
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë           BlueSecAudit v2.0 - Advanced          ‚ïë"
    echo "‚ïë        Bluetooth Security Auditing Tool         ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "‚ö†Ô∏è Para uso educacional e testes autorizados apenas"
    echo ""
    
    # Escanear dispositivos inicialmente
    if ! scan_devices_interactive; then
        echo "‚ö†Ô∏è Falha no escaneamento inicial - continuando com dispositivos fake"
    fi
    
    # Loop principal do menu
    while true; do
        echo ""
        echo "==== Menu Principal ===="
        echo "1. üéØ BlueSmack Attack (DoS L2CAP)"
        echo "2. üîç SDP Service Enumeration"
        echo "3. üìÅ OBEX Exploitation"
        echo "4. üîë PIN Brute Force"
        echo "5. üìä Full Security Audit"
        echo "6. üéÆ HID Injection Attacks"
        echo "7. üéµ Audio Interception"
        echo "8. üì± BLE (Low Energy) Attacks"
        echo "9. ‚öôÔ∏è  Configura√ß√µes"
        echo "10. ‚ÑπÔ∏è  Ajuda"
        echo "11. üö™ Sair"
        echo ""
        echo -n "Selecione uma op√ß√£o [1-11]: "
        
        read -r choice
        echo "Voc√™ selecionou: $choice"
        
        case "$choice" in
            1)
                execute_bluesmack
                ;;
            2)
                execute_sdp_enumeration
                ;;
            3)
                execute_obex_exploitation
                ;;
            4)
                execute_pin_bruteforce
                ;;
            5)
                execute_full_audit
                ;;
            6)
                execute_hid_injection
                ;;
            7)
                execute_audio_interception
                ;;
            8)
                execute_ble_attacks
                ;;
            9)
                show_config_menu
                ;;
            10)
                echo "‚ÑπÔ∏è BlueSecAudit v2.0 - Ferramenta de Auditoria Bluetooth"
                echo "üìö Para mais informa√ß√µes, consulte o README.md"
                ;;
            11)
                cleanup_and_exit
                ;;
            *)
                echo "‚ùå Op√ß√£o inv√°lida: $choice"
                ;;
        esac
        
        echo ""
        echo "Pressione Enter para continuar..."
        read -r
    done
}

# Executar fun√ß√£o principal
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi 